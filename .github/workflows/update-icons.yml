name: Process Icon Updates (DEPRECATED)

# ⚠️ DEPRECATED: This workflow is no longer used as of v3.0.0
# The Icon Editor now uses GitHub Contents API directly to create PRs.
# This file can be safely removed.
# See: GITHUB_API_FIX.md for details

on:
  repository_dispatch:
    types: [update-icons]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-icons:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Parse changes
        id: parse
        run: |
          # Get data from repository_dispatch payload
          echo '${{ toJson(github.event.client_payload.changes) }}' > /tmp/changes.json
          echo '${{ toJson(github.event.client_payload.files) }}' > /tmp/files.json
          
          # Count changes
          CHANGE_COUNT=$(cat /tmp/changes.json | jq '. | length')
          echo "change_count=$CHANGE_COUNT" >> $GITHUB_OUTPUT
          
          # Generate branch name
          BRANCH_NAME="icon-update-$(date +%s)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create branch
        run: |
          git checkout -b ${{ steps.parse.outputs.branch_name }}

      - name: Process icon changes
        run: |
          # Read changes and files
          CHANGES=$(cat /tmp/changes.json)
          FILES=$(cat /tmp/files.json)
          
          # Process each change
          echo "$CHANGES" | jq -c '.[]' | while IFS= read -r change; do
            CATEGORY=$(echo "$change" | jq -r '.category')
            NAME=$(echo "$change" | jq -r '.name')
            FILENAME=$(echo "$change" | jq -r '.fileName')
            
            # Find index
            INDEX=0
            for i in $(seq 0 $(( $(echo "$CHANGES" | jq '. | length') - 1 ))); do
              CHANGE_NAME=$(echo "$CHANGES" | jq -r ".[$i].name")
              CHANGE_CAT=$(echo "$CHANGES" | jq -r ".[$i].category")
              if [ "$CHANGE_NAME" = "$NAME" ] && [ "$CHANGE_CAT" = "$CATEGORY" ]; then
                INDEX=$i
                break
              fi
            done
            
            # Get base64 file data
            FILE_DATA=$(echo "$FILES" | jq -r ".\"file_$INDEX\"")
            
            # Create directory if it doesn't exist
            mkdir -p "public/icons/$CATEGORY"
            
            # Decode and save file
            TARGET_PATH="public/icons/$CATEGORY/$FILENAME"
            echo "$FILE_DATA" | base64 -d > "$TARGET_PATH"
            
            echo "✅ Updated: $TARGET_PATH"
          done

      - name: Commit changes
        run: |
          git add public/icons/
          
          # Generate commit message
          CHANGES=$(cat /tmp/changes.json)
          COMMIT_MSG="Update ${{ steps.parse.outputs.change_count }} icon(s) via Icon Editor"
          
          echo "$CHANGES" | jq -r '.[] | "- \(.category)/\(.name)"' | while read -r line; do
            COMMIT_MSG="$COMMIT_MSG"$'\n'"$line"
          done
          
          git commit -m "$COMMIT_MSG"

      - name: Push branch
        run: |
          git push origin ${{ steps.parse.outputs.branch_name }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHANGES=$(cat /tmp/changes.json)
          
          # Generate PR body
          PR_BODY="# Icon Updates"$'\n\n'
          PR_BODY+="This PR updates ${{ steps.parse.outputs.change_count }} icon(s) from the Icon Editor."$'\n\n'
          PR_BODY+="## Changed Icons"$'\n\n'
          
          # Group by category
          CATEGORIES=$(echo "$CHANGES" | jq -r '.[].category' | sort -u)
          
          for CATEGORY in $CATEGORIES; do
            COUNT=$(echo "$CHANGES" | jq --arg cat "$CATEGORY" '[.[] | select(.category == $cat)] | length')
            PR_BODY+="### $CATEGORY ($COUNT)"$'\n\n'
            
            echo "$CHANGES" | jq -c --arg cat "$CATEGORY" '.[] | select(.category == $cat)' | while IFS= read -r item; do
              NAME=$(echo "$item" | jq -r '.name')
              PATH=$(echo "$item" | jq -r '.path')
              PR_BODY+="- **$NAME** - \`$PATH\`"$'\n'
            done
            PR_BODY+=$'\n'
          done
          
          PR_BODY+=$'\n---\n\n'
          PR_BODY+="Generated by Icon Editor | [View Documentation](docs/ICON_UPDATE_WORKFLOW.md)"$'\n'
          PR_BODY+="Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          
          # Create PR
          PR_TITLE="Update ${{ steps.parse.outputs.change_count }} icon(s) via Icon Editor"
          
          echo "$PR_BODY" | gh pr create \
            --title "$PR_TITLE" \
            --body-file - \
            --base main \
            --head ${{ steps.parse.outputs.branch_name }}
          
          # Get PR URL
          PR_URL=$(gh pr view ${{ steps.parse.outputs.branch_name }} --json url -q .url)
          echo "✅ Pull Request created: $PR_URL"
